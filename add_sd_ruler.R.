add_sd_ruler <- function(p, outcome, legend_x = NULL, legend_y = NULL) {
  outcome_vals <- eval(substitute(outcome), p$data)
  m <- mean(outcome_vals, na.rm = TRUE)
  sd_val <- sd(outcome_vals, na.rm = TRUE)

  # Add SD segment
  segment_df <- data.frame(x = m, xend = m + sd_val, y = 0, yend = 0)
  p <- p +
    geom_segment(data = segment_df,
                 aes(x = x, xend = xend, y = y, yend = yend),
                 inherit.aes = FALSE,
                 color = "red", linewidth = 2)

  # Add red text with red outline using geom_label
  if (!is.null(legend_x) && !is.null(legend_y)) {
    label_df <- data.frame(x = legend_x, y = legend_y,
                           label = paste0("SD = ", round(sd_val, 2)))
    p <- p +
      geom_label(data = label_df,
                 aes(x = x, y = y, label = label),
                 inherit.aes = FALSE,
                 color = "red",           # text color
                 fill = NA,               # transparent background
                 label.size = 0.8,        # thickness of the border
                 label.r = unit(0.15, "lines"),  # rounded corners
                 label.padding = unit(0.4, "lines"),
                 fontface = "bold",
                 size = 5)
  }

  return(p)
}
